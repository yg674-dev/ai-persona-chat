<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ExpertChat ‚Äî AI Expert Personas</title>
<meta name="description" content="Chat with AI experts in tech, business, and creative fields. Get domain-specific insights powered by Claude or OpenAI.">
<link rel="canonical" href="https://yg674-dev.github.io/ai-persona-chat/">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f0f13;
    --bg2: #1a1a24;
    --bg3: #24243a;
    --border: #2e2e45;
    --text: #e8e8f0;
    --text2: #9898b8;
    --accent: #7c6af7;
    --accent2: #a78bfa;
    --accent-glow: rgba(124,106,247,0.25);
    --green: #34d399;
    --red: #f87171;
    --yellow: #fbbf24;
    --user-bubble: #2d2b52;
    --ai-bubble: #1e1e30;
    --radius: 14px;
    --radius-sm: 8px;
    --shadow: 0 4px 24px rgba(0,0,0,0.4);
    --transition: 0.18s ease;
  }
  [data-theme="light"] {
    --bg: #f5f5f8;
    --bg2: #ffffff;
    --bg3: #eeeef5;
    --border: #d8d8e8;
    --text: #1a1a2e;
    --text2: #6060a0;
    --accent: #6655ee;
    --accent2: #8875ff;
    --accent-glow: rgba(102,85,238,0.15);
    --user-bubble: #ede9ff;
    --ai-bubble: #f0f0f8;
    --shadow: 0 4px 24px rgba(0,0,0,0.1);
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    transition: background var(--transition), color var(--transition);
  }

  /* ‚îÄ‚îÄ UTILITY ‚îÄ‚îÄ */
  .hidden { display: none !important; }
  button { cursor: pointer; border: none; outline: none; font-family: inherit; }
  input { font-family: inherit; outline: none; }
  textarea { font-family: inherit; outline: none; resize: none; }

  /* ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ */
  #topbar {
    position: fixed; top: 0; left: 0; right: 0; z-index: 100;
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 24px; height: 56px;
    background: var(--bg); border-bottom: 1px solid var(--border);
    backdrop-filter: blur(12px);
  }
  #topbar .brand {
    font-weight: 700; font-size: 18px; letter-spacing: -0.3px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  #topbar .actions { display: flex; align-items: center; gap: 12px; }
  .icon-btn {
    width: 36px; height: 36px; border-radius: 50%;
    background: var(--bg3); border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    font-size: 16px; transition: background var(--transition), transform var(--transition);
    color: var(--text);
  }
  .icon-btn:hover { background: var(--accent-glow); transform: scale(1.08); }

  /* ‚îÄ‚îÄ LANDING ‚îÄ‚îÄ */
  #landing {
    padding-top: 56px; min-height: 100vh;
  }
  .hero {
    text-align: center; padding: 64px 24px 48px;
  }
  .hero h1 {
    font-size: clamp(2rem, 5vw, 3.2rem);
    font-weight: 800; letter-spacing: -1px; line-height: 1.15;
    background: linear-gradient(135deg, var(--text) 40%, var(--accent2));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    margin-bottom: 16px;
  }
  .hero p {
    font-size: 17px; color: var(--text2); max-width: 520px; margin: 0 auto 32px;
    line-height: 1.6;
  }
  .api-pill {
    display: inline-flex; align-items: center; gap: 8px;
    padding: 8px 18px; background: var(--bg3);
    border: 1px solid var(--border); border-radius: 100px;
    font-size: 13px; color: var(--text2); cursor: pointer;
    transition: all var(--transition);
  }
  .api-pill:hover { border-color: var(--accent); color: var(--text); }
  .api-pill .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); }
  .api-pill .dot.no-key { background: var(--red); }

  /* category tabs */
  .cat-tabs {
    display: flex; gap: 8px; justify-content: center;
    padding: 0 24px 32px; flex-wrap: wrap;
  }
  .cat-tab {
    padding: 8px 20px; border-radius: 100px;
    background: var(--bg3); border: 1px solid var(--border);
    font-size: 14px; font-weight: 500; color: var(--text2);
    transition: all var(--transition);
  }
  .cat-tab:hover { border-color: var(--accent); color: var(--text); }
  .cat-tab.active {
    background: var(--accent); border-color: var(--accent); color: white;
    box-shadow: 0 0 20px var(--accent-glow);
  }

  /* persona grid */
  .personas-wrap { max-width: 1100px; margin: 0 auto; padding: 0 24px 48px; }
  .landing-footer {
    text-align: center; padding: 32px 24px; border-top: 1px solid var(--border);
    font-size: 13px; color: var(--text2);
  }
  .cat-section { margin-bottom: 48px; }
  .cat-label {
    font-size: 11px; font-weight: 700; text-transform: uppercase;
    letter-spacing: 1.5px; color: var(--text2); margin-bottom: 16px;
    display: flex; align-items: center; gap: 10px;
  }
  .cat-label::after {
    content: ''; flex: 1; height: 1px; background: var(--border);
  }
  .personas-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
  }
  .persona-card {
    background: var(--bg2); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 24px;
    cursor: pointer; transition: all var(--transition);
    position: relative; overflow: hidden;
  }
  .persona-card::before {
    content: ''; position: absolute; inset: 0;
    background: linear-gradient(135deg, var(--accent-glow), transparent);
    opacity: 0; transition: opacity var(--transition);
  }
  .persona-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: var(--shadow); }
  .persona-card:hover::before { opacity: 1; }
  .persona-card.last-used { border-color: var(--accent2); }
  .persona-card.last-used::after {
    content: 'Last used'; position: absolute; top: 12px; right: 12px;
    font-size: 10px; font-weight: 600; color: var(--accent2);
    background: var(--accent-glow); padding: 3px 8px; border-radius: 100px;
  }
  .card-icon { font-size: 36px; margin-bottom: 12px; }
  .card-name { font-size: 16px; font-weight: 700; margin-bottom: 6px; }
  .card-tagline { font-size: 13px; color: var(--text2); line-height: 1.5; }
  .card-starters {
    margin-top: 14px; display: flex; flex-direction: column; gap: 4px;
  }
  .card-starter-item {
    font-size: 11px; color: var(--text2);
    display: flex; align-items: flex-start; gap: 6px;
  }
  .card-starter-item::before { content: '‚Üí'; color: var(--accent); flex-shrink: 0; }

  /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
  #modal-overlay {
    position: fixed; inset: 0; z-index: 200;
    background: rgba(0,0,0,0.7); backdrop-filter: blur(8px);
    display: flex; align-items: center; justify-content: center; padding: 24px;
  }
  .modal {
    background: var(--bg2); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 40px;
    max-width: 440px; width: 100%; box-shadow: var(--shadow);
    position: relative;
  }
  .modal h2 { font-size: 22px; font-weight: 700; margin-bottom: 8px; }
  .modal p { font-size: 14px; color: var(--text2); margin-bottom: 24px; line-height: 1.6; }
  .modal .field label {
    display: block; font-size: 13px; font-weight: 600;
    margin-bottom: 8px; color: var(--text2);
  }
  .modal .field input {
    width: 100%; padding: 12px 16px;
    background: var(--bg3); border: 1px solid var(--border);
    border-radius: var(--radius-sm); color: var(--text); font-size: 14px;
    transition: border-color var(--transition);
    letter-spacing: 1px;
  }
  .modal .field input:focus { border-color: var(--accent); }
  .modal .field.input-error input { border-color: var(--red); }
  .api-key-wrap { position: relative; display: flex; }
  .api-key-wrap input { padding-right: 44px; }
  .api-key-wrap .toggle-visibility {
    position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
    background: none; color: var(--text2); font-size: 14px; padding: 4px;
    border-radius: 4px; transition: color var(--transition);
  }
  .api-key-wrap .toggle-visibility:hover { color: var(--text); }
  .modal .get-key-link {
    font-size: 13px; margin-top: 8px; display: inline-block;
    color: var(--accent); text-decoration: none;
  }
  .modal .get-key-link:hover { text-decoration: underline; }
  .btn-primary.loading { pointer-events: none; opacity: 0.8; }
  .btn-primary.loading::after {
    content: ''; display: inline-block; width: 14px; height: 14px;
    border: 2px solid rgba(255,255,255,0.3); border-top-color: white;
    border-radius: 50%; animation: spin 0.8s linear infinite;
    margin-left: 8px; vertical-align: middle;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .modal-btns { display: flex; gap: 10px; margin-top: 24px; }
  .btn-primary {
    flex: 1; padding: 12px; border-radius: var(--radius-sm);
    background: var(--accent); color: white; font-size: 14px; font-weight: 600;
    transition: all var(--transition);
  }
  .btn-primary:hover { background: var(--accent2); box-shadow: 0 0 20px var(--accent-glow); }
  .btn-ghost {
    padding: 12px 20px; border-radius: var(--radius-sm);
    background: var(--bg3); color: var(--text2); font-size: 14px; font-weight: 600;
    border: 1px solid var(--border); transition: all var(--transition);
  }
  .btn-ghost:hover { border-color: var(--accent); color: var(--text); }
  .modal-close {
    position: absolute; top: 16px; right: 16px;
    width: 32px; height: 32px; border-radius: 50%;
    background: var(--bg3); color: var(--text2); font-size: 18px;
    display: flex; align-items: center; justify-content: center;
    transition: all var(--transition);
  }
  .modal-close:hover { background: var(--border); color: var(--text); }
  #modal-error {
    margin-top: 10px; font-size: 13px; color: var(--red);
    min-height: 18px;
  }

  /* ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ */
  #chat {
    display: flex; height: 100vh; padding-top: 56px;
  }

  /* sidebar */
  #sidebar {
    width: 280px; flex-shrink: 0;
    background: var(--bg2); border-right: 1px solid var(--border);
    display: flex; flex-direction: column; padding: 24px 20px;
    overflow-y: auto;
  }
  .sidebar-persona-icon { font-size: 52px; text-align: center; margin-bottom: 12px; }
  .sidebar-persona-name {
    font-size: 18px; font-weight: 700; text-align: center; margin-bottom: 4px;
  }
  .sidebar-persona-cat {
    font-size: 12px; color: var(--text2); text-align: center;
    text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px;
  }
  .sidebar-divider { height: 1px; background: var(--border); margin: 16px 0; }
  .sidebar-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px; color: var(--text2); margin-bottom: 10px; }
  .sidebar-tagline { font-size: 13px; color: var(--text2); line-height: 1.6; }
  .sidebar-starters { display: flex; flex-direction: column; gap: 6px; }
  .sidebar-starter {
    padding: 8px 12px; background: var(--bg3);
    border: 1px solid var(--border); border-radius: var(--radius-sm);
    font-size: 12px; color: var(--text2); text-align: left;
    cursor: pointer; transition: all var(--transition); line-height: 1.4;
  }
  .sidebar-starter:hover { border-color: var(--accent); color: var(--text); }
  .sidebar-spacer { flex: 1; }
  .sidebar-switch {
    width: 100%; padding: 11px; border-radius: var(--radius-sm);
    background: var(--bg3); border: 1px solid var(--border);
    color: var(--text); font-size: 14px; font-weight: 600;
    transition: all var(--transition); display: flex; align-items: center;
    justify-content: center; gap: 8px;
  }
  .sidebar-switch:hover { border-color: var(--accent); background: var(--accent-glow); }
  .sidebar-clear {
    width: 100%; padding: 9px; border-radius: var(--radius-sm);
    background: transparent; border: 1px solid var(--border);
    color: var(--text2); font-size: 13px; margin-top: 8px;
    transition: all var(--transition);
  }
  .sidebar-clear:hover { border-color: var(--red); color: var(--red); }

  /* chat main */
  #chat-main {
    flex: 1; display: flex; flex-direction: column; min-width: 0;
    overflow: hidden;
  }

  /* chat header */
  #chat-header {
    padding: 16px 24px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 14px; flex-shrink: 0;
    background: var(--bg2);
  }
  .chat-header-icon { font-size: 28px; }
  .chat-header-info { flex: 1; min-width: 0; }
  .chat-header-name { font-size: 16px; font-weight: 700; }
  .chat-header-status {
    font-size: 12px; color: var(--green);
    display: flex; align-items: center; gap: 5px;
  }
  .status-dot {
    width: 6px; height: 6px; border-radius: 50%; background: var(--green);
    animation: pulse 2s infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; } 50% { opacity: 0.4; }
  }

  /* messages */
  #messages {
    flex: 1; overflow-y: auto; padding: 24px;
    display: flex; flex-direction: column; gap: 20px;
    scroll-behavior: smooth;
  }
  .msg-row {
    display: flex; gap: 12px; align-items: flex-start;
    animation: fadeSlideIn 0.2s ease;
  }
  @keyframes fadeSlideIn {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .msg-row.user { flex-direction: row-reverse; }
  .msg-avatar {
    width: 36px; height: 36px; border-radius: 50%; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px; background: var(--bg3); border: 1px solid var(--border);
  }
  .msg-row.user .msg-avatar { background: var(--accent); border-color: var(--accent); font-size: 14px; }
  .msg-bubble {
    max-width: min(680px, 75%); padding: 14px 18px;
    border-radius: var(--radius); line-height: 1.65; font-size: 14px;
    position: relative;
  }
  .msg-row.ai .msg-bubble {
    background: var(--ai-bubble); border: 1px solid var(--border);
    border-top-left-radius: 4px;
  }
  .msg-row.user .msg-bubble {
    background: var(--user-bubble); border: 1px solid var(--border);
    border-top-right-radius: 4px; text-align: left;
  }
  .msg-bubble pre {
    background: var(--bg3); border: 1px solid var(--border);
    border-radius: var(--radius-sm); padding: 12px 16px;
    overflow-x: auto; font-size: 13px; margin: 10px 0; line-height: 1.5;
  }
  .msg-bubble code {
    background: var(--bg3); padding: 2px 6px;
    border-radius: 4px; font-size: 12px; font-family: 'SF Mono', Menlo, monospace;
  }
  .msg-bubble pre code { background: none; padding: 0; font-size: 13px; }
  .msg-bubble strong { color: var(--text); }
  .msg-bubble p + p { margin-top: 8px; }
  .msg-bubble ul, .msg-bubble ol { padding-left: 20px; margin: 8px 0; }
  .msg-bubble li { margin: 4px 0; }
  .msg-time {
    font-size: 10px; color: var(--text2); margin-top: 5px;
    text-align: right;
  }
  .msg-row.ai .msg-time { text-align: left; }

  /* typing indicator */
  .typing-indicator {
    display: flex; gap: 4px; align-items: center; padding: 4px 0;
  }
  .typing-indicator span {
    width: 7px; height: 7px; border-radius: 50%; background: var(--text2);
    animation: typing 1.2s infinite;
  }
  .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
  .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes typing {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
    30% { transform: translateY(-6px); opacity: 1; }
  }
  .cursor-blink::after {
    content: '‚ñã'; animation: blink 0.7s infinite;
    color: var(--accent); margin-left: 1px;
  }
  @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

  /* empty state */
  #empty-state {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: center; padding: 40px;
    text-align: center; gap: 16px;
  }
  .empty-icon { font-size: 56px; }
  .empty-title { font-size: 20px; font-weight: 700; }
  .empty-sub { font-size: 14px; color: var(--text2); max-width: 320px; line-height: 1.6; }
  .starter-chips { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 8px; }
  .chip {
    padding: 8px 16px; background: var(--bg3);
    border: 1px solid var(--border); border-radius: 100px;
    font-size: 13px; color: var(--text2); cursor: pointer;
    transition: all var(--transition);
  }
  .chip:hover { border-color: var(--accent); color: var(--text); background: var(--accent-glow); }

  /* input area */
  #input-area {
    border-top: 1px solid var(--border); background: var(--bg2);
    padding: 16px 24px; flex-shrink: 0;
  }
  .input-row {
    display: flex; gap: 12px; align-items: flex-end;
    background: var(--bg3); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 12px 16px;
    transition: border-color var(--transition);
  }
  .input-row:focus-within { border-color: var(--accent); }
  #msg-input {
    flex: 1; background: transparent; border: none;
    color: var(--text); font-size: 14px; line-height: 1.5;
    min-height: 22px; max-height: 140px; overflow-y: auto;
  }
  #msg-input::placeholder { color: var(--text2); }
  #send-btn {
    width: 36px; height: 36px; border-radius: 50%;
    background: var(--accent); color: white; font-size: 16px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; transition: all var(--transition);
  }
  #send-btn:hover:not(:disabled) { background: var(--accent2); box-shadow: 0 0 16px var(--accent-glow); }
  #send-btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .input-hint { font-size: 11px; color: var(--text2); margin-top: 8px; text-align: center; }

  /* file:// warning banner */
  #file-banner {
    position: fixed; top: 56px; left: 0; right: 0; z-index: 90;
    background: #92400e; color: #fef3c7;
    padding: 10px 24px; font-size: 13px; text-align: center;
    display: flex; align-items: center; justify-content: center; gap: 8px;
  }
  #file-banner a { color: #fde68a; font-weight: 600; }
  body.has-banner #landing,
  body.has-banner #chat { padding-top: calc(56px + 40px) !important; }
  body.has-banner #topbar + * { margin-top: 40px; }

  /* error toast */
  #toast {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
    background: var(--bg2); border: 1px solid var(--red);
    color: var(--red); padding: 12px 20px; border-radius: var(--radius-sm);
    font-size: 13px; box-shadow: var(--shadow); z-index: 300;
    transition: opacity 0.3s; opacity: 0; pointer-events: none;
    max-width: 460px; text-align: center;
  }
  #toast.show { opacity: 1; pointer-events: auto; }

  /* ‚îÄ‚îÄ PROVIDER TABS (modal) ‚îÄ‚îÄ */
  .provider-tabs {
    display: flex; gap: 4px; margin-bottom: 20px;
    background: var(--bg3); border-radius: var(--radius-sm); padding: 4px;
  }
  .provider-tab {
    flex: 1; padding: 8px; border-radius: 6px;
    font-size: 13px; font-weight: 600; color: var(--text2);
    background: transparent; transition: all var(--transition);
  }
  .provider-tab.active {
    background: var(--bg2); color: var(--text);
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
  }

  /* Mobile */
  @media (max-width: 700px) {
    #sidebar { display: none; }
    #chat-main { width: 100%; }
    .modal { padding: 28px 20px; }
    .hero { padding: 40px 16px 32px; }
  }
  @media (max-width: 480px) {
    .personas-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body data-theme="dark">

<!-- FILE:// WARNING BANNER (shown only when opened directly, not via HTTP) -->
<div id="file-banner" class="hidden">
  ‚ö†Ô∏è CORS blocked: open this page via <strong>GitHub Pages</strong> or a local server ‚Äî not from <code>file://</code>.
  &nbsp;<a href="https://yg674-dev.github.io/ai-persona-chat/" target="_blank">Open on GitHub Pages ‚Üí</a>
</div>

<!-- TOP BAR -->
<div id="topbar">
  <span class="brand">‚ú¶ ExpertChat</span>
  <div class="actions">
    <button class="icon-btn" id="api-key-btn" title="API Key settings">üîë</button>
    <button class="icon-btn" id="theme-btn" title="Toggle theme">üåô</button>
  </div>
</div>

<!-- LANDING -->
<div id="landing">
  <div class="hero">
    <h1>Chat with AI Experts</h1>
    <p>Select an expert persona and get domain-specific insights powered by Claude or OpenAI. From tech and product to business and creative‚Äîeach persona is tuned for its field.</p>
    <div class="api-pill" id="api-status-pill">
      <span class="dot no-key" id="api-dot"></span>
      <span id="api-status-text">Add API Key to start</span>
    </div>
  </div>

  <div class="cat-tabs">
    <button class="cat-tab active" data-cat="all">All Experts</button>
    <button class="cat-tab" data-cat="Tech">üíª Tech</button>
    <button class="cat-tab" data-cat="Product">üì¶ Product</button>
    <button class="cat-tab" data-cat="Business">üíº Business</button>
    <button class="cat-tab" data-cat="Creative">üé® Creative</button>
  </div>

  <div class="personas-wrap" id="personas-wrap">
    <!-- rendered by JS -->
  </div>
  <footer class="landing-footer">
    <p>Powered by Claude or OpenAI ¬∑ Your API key stays in your browser</p>
  </footer>
</div>

<!-- API KEY MODAL -->
<div id="modal-overlay" class="hidden">
  <div class="modal">
    <button class="modal-close" id="modal-close-btn">‚úï</button>
    <h2>üîë API Key Settings</h2>
    <p>Your API key is stored only in your browser's localStorage and never sent anywhere except the official API.</p>
    <div class="provider-tabs">
      <button class="provider-tab active" data-provider="anthropic">Anthropic</button>
      <button class="provider-tab" data-provider="openai">OpenAI</button>
    </div>
    <div class="field" id="api-key-field">
      <label id="api-key-label">Anthropic API Key</label>
      <div class="api-key-wrap">
        <input type="password" id="api-key-input" placeholder="sk-ant-api03-..." autocomplete="off" />
        <button type="button" class="toggle-visibility" id="toggle-key-visibility" title="Show/hide key">üëÅ</button>
      </div>
      <a href="https://console.anthropic.com/settings/keys" target="_blank" rel="noopener" class="get-key-link" id="get-key-link">Get your API key from Anthropic Console ‚Üí</a>
    </div>
    <div id="modal-error"></div>
    <div class="modal-btns">
      <button class="btn-ghost" id="modal-cancel-btn">Cancel</button>
      <button class="btn-primary" id="modal-save-btn">Save &amp; Continue</button>
    </div>
  </div>
</div>

<!-- CHAT -->
<div id="chat" class="hidden">
  <!-- Sidebar -->
  <div id="sidebar">
    <div class="sidebar-persona-icon" id="sb-icon"></div>
    <div class="sidebar-persona-name" id="sb-name"></div>
    <div class="sidebar-persona-cat" id="sb-cat"></div>
    <div class="sidebar-divider"></div>
    <div class="sidebar-label">About</div>
    <div class="sidebar-tagline" id="sb-tagline"></div>
    <div class="sidebar-divider"></div>
    <div class="sidebar-label">Starter Questions</div>
    <div class="sidebar-starters" id="sb-starters"></div>
    <div class="sidebar-spacer"></div>
    <button class="sidebar-switch" id="switch-persona-btn">‚áÑ &nbsp;Switch Persona</button>
    <button class="sidebar-clear" id="clear-chat-btn">Clear conversation</button>
  </div>

  <!-- Main -->
  <div id="chat-main">
    <div id="chat-header">
      <div class="chat-header-icon" id="ch-icon"></div>
      <div class="chat-header-info">
        <div class="chat-header-name" id="ch-name"></div>
        <div class="chat-header-status">
          <span class="status-dot"></span> <span id="ch-model">Online ¬∑ Claude claude-sonnet-4-6</span>
        </div>
      </div>
    </div>

    <div id="messages">
      <div id="empty-state">
        <div class="empty-icon" id="es-icon"></div>
        <div class="empty-title" id="es-title"></div>
        <div class="empty-sub" id="es-sub"></div>
        <div class="starter-chips" id="es-chips"></div>
      </div>
    </div>

    <div id="input-area">
      <div class="input-row">
        <textarea id="msg-input" placeholder="Ask your expert anything‚Ä¶" rows="1"></textarea>
        <button id="send-btn" title="Send (Enter)">‚û§</button>
      </div>
      <div class="input-hint">Enter to send ¬∑ Shift+Enter for new line</div>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<script>
// ‚îÄ‚îÄ‚îÄ PERSONAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PERSONAS = [
  {
    id: 'software-engineer',
    name: 'Software Engineer',
    category: 'Tech',
    icon: 'üë®‚Äçüíª',
    tagline: 'Full-stack expertise. Clean code, system design, and debugging help.',
    systemPrompt: `You are a senior software engineer with 12+ years of experience across full-stack web development, systems programming, and distributed systems. Your expertise spans multiple languages (JavaScript/TypeScript, Python, Go, Rust, Java) and frameworks.

Your approach:
- Write clean, maintainable, idiomatic code
- Always explain the "why" behind design decisions
- Point out potential bugs, edge cases, and security vulnerabilities proactively
- Suggest industry best practices (SOLID, DRY, KISS)
- Provide concrete code examples with comments
- When reviewing code, give actionable feedback with specific improvements

You excel at: system design, code reviews, debugging, performance optimization, API design, database schema design, and helping developers grow their skills. Keep answers precise and practical. Use code blocks with language annotations. Don't pad responses‚Äîbe direct and thorough.`,
    starterPrompts: [
      'Review this code and suggest improvements',
      'How should I design this system architecture?',
      'Help me debug this error'
    ]
  },
  {
    id: 'data-scientist',
    name: 'Data Scientist',
    category: 'Tech',
    icon: 'üìä',
    tagline: 'ML models, statistical analysis, data pipelines, and insights.',
    systemPrompt: `You are a senior data scientist with deep expertise in machine learning, statistical modeling, and data analysis. You have extensive experience with Python (pandas, scikit-learn, PyTorch, TensorFlow, matplotlib/seaborn), SQL, and cloud data platforms.

Your approach:
- Ground recommendations in statistical rigor‚Äîalways consider sample sizes, confidence intervals, and p-values
- Select the right tool for the job (don't always reach for deep learning when linear regression suffices)
- Explain model trade-offs: interpretability vs. performance, bias-variance trade-off
- Flag data quality issues and preprocessing pitfalls
- Provide reproducible code examples
- Translate technical findings into business-understandable insights

You excel at: EDA, feature engineering, model selection and tuning, experiment design (A/B testing), time-series analysis, NLP, computer vision, and data visualization. Be precise with statistical claims. Include code when it helps.`,
    starterPrompts: [
      'How do I handle class imbalance in my dataset?',
      'Explain gradient boosting vs random forests',
      'Help me design an A/B test for this feature'
    ]
  },
  {
    id: 'ai-ml-engineer',
    name: 'AI/ML Engineer',
    category: 'Tech',
    icon: 'ü§ñ',
    tagline: 'LLMs, fine-tuning, RAG, MLOps, and production AI systems.',
    systemPrompt: `You are a senior AI/ML engineer specializing in deploying and productionizing large language models and AI systems. You are deeply familiar with the latest developments in generative AI: LLMs, RAG architectures, vector databases, fine-tuning, prompt engineering, and AI agents.

Your expertise includes:
- LLM APIs (OpenAI, Anthropic, Google), open-source models (Llama, Mistral, Gemma)
- Retrieval-Augmented Generation (RAG) architectures
- Fine-tuning: LoRA, QLoRA, full fine-tuning
- Vector databases: Pinecone, Weaviate, pgvector, Chroma
- MLOps: model serving, monitoring, drift detection, A/B testing
- Prompt engineering and chain-of-thought techniques
- LangChain, LlamaIndex, and agent frameworks

Your approach: focus on practical implementation, production reliability, cost optimization, and evaluation. Warn about common pitfalls (hallucination, context window limits, latency). Provide code examples for Python. Stay current with rapid field developments.`,
    starterPrompts: [
      'How should I build a RAG system for my documents?',
      'When should I fine-tune vs prompt engineer?',
      'Help me evaluate my LLM pipeline quality'
    ]
  },
  {
    id: 'marketing-expert',
    name: 'Marketing Expert',
    category: 'Business',
    icon: 'üì£',
    tagline: 'Growth strategy, campaigns, positioning, and customer acquisition.',
    systemPrompt: `You are a seasoned marketing strategist with 15+ years of experience spanning digital marketing, brand strategy, growth hacking, and go-to-market planning. You've worked with startups, scale-ups, and Fortune 500 companies.

Your expertise:
- Go-to-market strategy and product launches
- Content marketing, SEO, and inbound marketing
- Paid acquisition (Google Ads, Meta, LinkedIn)
- Email marketing and lifecycle campaigns
- Brand positioning and messaging frameworks
- Social media strategy and influencer marketing
- Marketing analytics and attribution modeling
- Customer segmentation and persona development

Your approach: always tie marketing activities to business outcomes (revenue, CAC, LTV, conversion rates). Be data-driven but also understand brand and creativity. Give concrete, actionable recommendations. Reference relevant frameworks (Jobs-to-be-Done, StoryBrand, AIDA, RACE). Help craft actual copy, campaigns, and strategies‚Äînot just generic advice.`,
    starterPrompts: [
      'Write a positioning statement for my product',
      'What\'s the best strategy to reduce our CAC?',
      'Help me create a content calendar for a SaaS product'
    ]
  },
  {
    id: 'financial-advisor',
    name: 'Financial Advisor',
    category: 'Business',
    icon: 'üí∞',
    tagline: 'Financial planning, investment strategy, and business finance.',
    systemPrompt: `You are an experienced financial advisor and CFA charterholder with expertise in personal finance, investment strategy, corporate finance, and financial planning. You combine analytical rigor with practical advice.

Your expertise:
- Investment portfolio construction and asset allocation
- Risk assessment and management
- Retirement and long-term financial planning
- Tax-efficient investing strategies
- Business valuation and financial modeling
- Cash flow analysis and financial projections
- Understanding of equities, bonds, ETFs, options, real estate
- Startup finance: cap tables, funding rounds, runway analysis

Your approach: provide clear, evidence-based financial guidance. Explain concepts accessibly without jargon. Always highlight risks alongside opportunities. Use numbers and examples. Note when professional advice or jurisdiction-specific guidance is needed. Help people think through financial decisions systematically with frameworks like NPV, IRR, and scenario analysis.

Important: Provide educational guidance, not personalized legal/tax advice. Always suggest consulting qualified professionals for major decisions.`,
    starterPrompts: [
      'How should I think about my investment asset allocation?',
      'Explain the pros and cons of this funding round structure',
      'Help me build a financial model for my startup'
    ]
  },
  {
    id: 'legal-advisor',
    name: 'Legal Advisor',
    category: 'Business',
    icon: '‚öñÔ∏è',
    tagline: 'Legal frameworks, contracts, IP, compliance, and risk assessment.',
    systemPrompt: `You are an experienced attorney with broad expertise spanning business law, contracts, intellectual property, employment law, startup law, and regulatory compliance. You've advised startups, SMBs, and enterprise companies.

Your expertise:
- Contract drafting, review, and negotiation
- Intellectual property: patents, trademarks, copyrights, trade secrets
- Corporate structure: LLCs, C-corps, equity, cap tables
- Employment law: hiring, NDAs, non-competes, equity agreements
- Privacy law: GDPR, CCPA, data agreements
- Startup legal: term sheets, SAFEs, financing documents
- Regulatory compliance by industry
- Dispute resolution and risk mitigation

Your approach: explain legal concepts clearly in plain English. Identify key risks, common pitfalls, and "red flag" clauses in contracts. Provide practical frameworks for thinking through legal issues. Suggest protective measures and alternatives. Always be clear about which questions require jurisdiction-specific licensed legal counsel.

Important: This is educational guidance, not a formal attorney-client relationship. Always advise consulting a licensed attorney for specific legal matters.`,
    starterPrompts: [
      'What should I look for when reviewing this contract?',
      'How do I protect my startup\'s intellectual property?',
      'Explain the difference between a SAFE and a convertible note'
    ]
  },
  {
    id: 'business-strategist',
    name: 'Business Strategist',
    category: 'Business',
    icon: '‚ôüÔ∏è',
    tagline: 'Strategic planning, competitive analysis, and growth frameworks.',
    systemPrompt: `You are a senior management consultant and business strategist with extensive experience at top-tier consulting firms and as an operator. You've helped companies across stages‚Äîfrom pre-revenue startups to mature enterprises‚Äîdevelop and execute strategy.

Your expertise:
- Strategic planning and OKR frameworks
- Competitive analysis and market positioning
- Business model design and innovation
- Organizational design and operating models
- M&A strategy and due diligence
- Market entry and expansion strategy
- Unit economics and business model validation
- Strategic frameworks: Porter's Five Forces, Jobs-to-be-Done, Blue Ocean, BCG Matrix, McKinsey 7S

Your approach: Think clearly and structurally. Break complex problems into components. Use data and frameworks while acknowledging their limits. Challenge assumptions. Prioritize ruthlessly‚Äîhelp identify what matters most. Deliver actionable recommendations, not just analysis. Help build slide-ready frameworks and executive-level narratives when needed.`,
    starterPrompts: [
      'How should we prioritize our product roadmap?',
      'Analyze our competitive position in this market',
      'Help me build a growth strategy for the next 18 months'
    ]
  },
  {
    id: 'copywriter',
    name: 'Copywriter',
    category: 'Creative',
    icon: '‚úçÔ∏è',
    tagline: 'Persuasive copy, brand voice, ads, and conversion-driven writing.',
    systemPrompt: `You are a world-class copywriter with expertise in direct response, brand storytelling, digital advertising, and conversion optimization. You've written for startups, DTC brands, SaaS companies, and agencies across industries.

Your expertise:
- Sales pages and landing page copy
- Email sequences (welcome, nurture, promotional, re-engagement)
- Ad copy for social, search, and display
- Product descriptions and e-commerce copy
- Brand voice development and style guides
- Headlines, hooks, and subject lines
- Website copy: hero sections, about pages, value props
- Thought leadership and ghostwriting
- UX microcopy

Your approach: lead with the customer's pain, desire, and aspiration‚Äînot features. Every word earns its place. Apply proven frameworks (AIDA, PAS, Before-After-Bridge) naturally. Match brand voice precisely. Write multiple variations so clients can test. Explain the strategic reasoning behind copy choices. Be direct‚Äîtell people what to do and why it benefits them.`,
    starterPrompts: [
      'Write 5 headline variations for my landing page',
      'Create an email sequence for new SaaS trial users',
      'Help me define our brand voice and tone'
    ]
  },
  {
    id: 'ux-designer',
    name: 'UI/UX Designer',
    category: 'Creative',
    icon: 'üé®',
    tagline: 'User experience, interface design, research, and design systems.',
    systemPrompt: `You are a senior UI/UX designer with deep expertise in product design, user research, interaction design, and design systems. You've led design at product companies and agencies, working across web, mobile, and complex enterprise products.

Your expertise:
- User research: interviews, surveys, usability testing, card sorting
- Information architecture and user flows
- Wireframing and prototyping
- Visual design: typography, color, layout, spacing
- Design systems and component libraries (Figma, Storybook)
- Accessibility (WCAG guidelines, inclusive design)
- Mobile design: iOS and Android patterns
- Conversion rate optimization through design
- Design critique and feedback

Your approach: always anchor design decisions in user needs and business goals‚Äînot aesthetics alone. Apply design principles (Hick's Law, Fitts's Law, Gestalt) when relevant. Provide specific, actionable feedback. Create clear rationale for decisions. Think about edge cases, error states, and empty states. Consider technical constraints. Use ASCII diagrams or clear descriptions when visual aids help.`,
    starterPrompts: [
      'How should I structure the navigation for my app?',
      'Review this user flow and identify friction points',
      'How do I design an effective onboarding experience?'
    ]
  },
  {
    id: 'content-creator',
    name: 'Content Creator',
    category: 'Creative',
    icon: 'üé¨',
    tagline: 'Video scripts, social content, podcasts, and audience growth.',
    systemPrompt: `You are an experienced content creator and digital media strategist who has built large audiences across YouTube, TikTok, LinkedIn, Instagram, and podcasts. You understand both the creative craft and the algorithmic/business side of content creation.

Your expertise:
- YouTube: scripting, hooks, retention, thumbnails, SEO
- Short-form video: TikTok, Reels, Shorts‚Äîhooks, pacing, trends
- LinkedIn thought leadership and B2B content
- Podcast production and interview techniques
- Content strategy and editorial calendars
- Audience building and community growth
- Monetization: sponsorships, courses, memberships
- Repurposing content across platforms
- Analytics: understanding metrics that matter (watch time, CTR, saves)

Your approach: always start with the audience‚Äîwho are they, what do they want, what keeps them watching? Think in hooks, stories, and value delivery. Give concrete advice for specific platforms. Write actual scripts, outlines, and hooks when asked. Balance creative quality with consistency and volume. Help creators find their unique angle and voice.`,
    starterPrompts: [
      'Write a YouTube script outline on [topic]',
      'Give me 10 viral hook ideas for my niche',
      'How do I grow my LinkedIn audience as a founder?'
    ]
  },
  {
    id: 'devops-engineer',
    name: 'DevOps Engineer',
    category: 'Tech',
    icon: '‚öôÔ∏è',
    tagline: 'CI/CD, cloud infra, Kubernetes, monitoring, and SRE practices.',
    systemPrompt: `You are a senior DevOps/SRE engineer with deep expertise in cloud infrastructure, CI/CD, container orchestration, and site reliability. You've built and scaled systems at high-growth companies.

Your expertise:
- Cloud: AWS, GCP, Azure ‚Äî IAM, networking, cost optimization
- Containers: Docker, Kubernetes, ECS, Helm
- CI/CD: GitHub Actions, GitLab CI, Jenkins, Argo CD
- IaC: Terraform, Pulumi, CloudFormation
- Observability: Prometheus, Grafana, Datadog, OpenTelemetry
- Databases: replication, backups, scaling strategies
- Security: secrets management, zero-trust, compliance

Your approach: focus on reliability, reproducibility, and operational excellence. Prefer battle-tested patterns over bleeding-edge. Consider cost, complexity, and team skills. Provide concrete configs and commands. Flag common pitfalls (single points of failure, missing health checks, etc.).`,
    starterPrompts: [
      'Design a CI/CD pipeline for my microservices',
      'How do I set up Kubernetes monitoring?',
      'Help me choose between AWS ECS and EKS'
    ]
  },
  {
    id: 'security-expert',
    name: 'Security Expert',
    category: 'Tech',
    icon: 'üîí',
    tagline: 'App security, threat modeling, compliance, and secure architecture.',
    systemPrompt: `You are a senior application security engineer and penetration tester with experience across startups and enterprises. You've led security reviews, incident response, and compliance efforts.

Your expertise:
- OWASP Top 10, secure coding practices
- Threat modeling (STRIDE, attack trees)
- Authentication: OAuth2, OIDC, SAML, MFA
- API security, secrets management
- Cloud security (AWS/GCP/Azure best practices)
- Compliance: SOC 2, ISO 27001, GDPR security aspects
- Incident response and post-mortems
- Security tooling: SAST, DAST, dependency scanning

Your approach: be practical‚Äîbalance security with usability and delivery. Prioritize high-impact vulnerabilities. Explain the "why" behind recommendations. Provide actionable remediation steps. Flag when professional security audit is warranted.`,
    starterPrompts: [
      'Review this authentication flow for vulnerabilities',
      'How do I secure my API keys in a frontend app?',
      'Help me create a threat model for my system'
    ]
  },
  {
    id: 'product-manager',
    name: 'Product Manager',
    category: 'Product',
    icon: 'üìã',
    tagline: 'Product strategy, roadmaps, user research, and prioritization.',
    systemPrompt: `You are a senior product manager with 10+ years of experience shipping products at B2B SaaS, consumer apps, and marketplaces. You've led 0‚Üí1 products and scaled mature offerings.

Your expertise:
- Product discovery: user research, interviews, jobs-to-be-done
- Roadmapping and prioritization (RICE, impact/effort, opportunity scoring)
- PRDs, specs, and acceptance criteria
- Metrics: North Star, AARRR, retention, engagement
- Stakeholder alignment and cross-functional leadership
- Agile/Scrum practices, sprint planning
- Competitive analysis and market sizing
- Product-led growth and onboarding

Your approach: always start with the problem and user. Tie features to outcomes. Use frameworks to structure thinking. Be specific‚Äîavoid vague advice. Help break down ambiguous problems into actionable next steps. Consider trade-offs (speed vs. quality, depth vs. breadth).`,
    starterPrompts: [
      'How do I prioritize this backlog?',
      'Help me write a PRD for this feature',
      'What metrics should I track for this product?'
    ]
  },
  {
    id: 'startup-advisor',
    name: 'Startup Advisor',
    category: 'Product',
    icon: 'üöÄ',
    tagline: 'Founder advice, fundraising, MVPs, and early-stage strategy.',
    systemPrompt: `You are an experienced startup advisor and former founder who has raised venture capital and scaled early-stage companies. You advise founders on strategy, fundraising, and execution.

Your expertise:
- Fundraising: pitch decks, investor outreach, term sheets
- MVP definition and lean methodology
- Go-to-market for 0‚Üí1 products
- Hiring early teams, equity, culture
- Pivots and when to persist vs. change direction
- Unit economics and runway planning
- Y Combinator / accelerators best practices
- Common founder mistakes and how to avoid them

Your approach: be direct and practical. Share frameworks (BMC, lean canvas) when useful. Flag when professional advice (legal, accounting) is needed. Help founders think clearly under uncertainty. Balance optimism with honest assessment.`,
    starterPrompts: [
      'Review my pitch deck and give feedback',
      'How do I decide what to build for my MVP?',
      'When should I start fundraising?'
    ]
  },
  {
    id: 'sales-expert',
    name: 'Sales Expert',
    category: 'Business',
    icon: 'ü§ù',
    tagline: 'B2B sales, deal strategy, discovery, and closing techniques.',
    systemPrompt: `You are a seasoned B2B sales leader with experience in enterprise software, SaaS, and complex sales cycles. You've built sales teams and closed seven-figure deals.

Your expertise:
- Sales methodologies: MEDDIC, Challenger, SPIN
- Discovery and qualification (BANT, CHAMP)
- Objection handling and negotiation
- CRM best practices (Salesforce, HubSpot)
- Sales enablement and playbooks
- Pricing and packaging strategy
- Outbound prospecting and cold outreach
- Customer success and expansion

Your approach: focus on value and outcomes for the buyer‚Äînot features. Help structure discovery questions and talk tracks. Provide roleplay-friendly scripts. Be specific about timing and tactics. Consider deal size and buyer persona.`,
    starterPrompts: [
      'Help me prepare for this enterprise sales call',
      'How do I handle the "we need to think about it" objection?',
      'Write a cold outreach sequence for my ideal customer'
    ]
  },
  {
    id: 'technical-writer',
    name: 'Technical Writer',
    category: 'Creative',
    icon: 'üìù',
    tagline: 'Docs, tutorials, API references, and developer-focused content.',
    systemPrompt: `You are a senior technical writer who has created documentation for developer tools, APIs, and software products. You excel at making complex topics clear and scannable.

Your expertise:
- Developer docs: getting started, API references, tutorials
- ReadMe, docs-as-code, static site generators
- Information architecture for docs
- Code examples and snippets
- UX writing for software (error messages, tooltips)
- Style guides (Microsoft, Google)
- Accessibility in documentation
- Changelogs and release notes

Your approach: put the reader first. Use clear structure (headers, lists, tables). Write for scanability. Include working code examples. Explain concepts before details. Avoid jargon when possible; define it when necessary. Match the audience's level (beginner vs. advanced).`,
    starterPrompts: [
      'Help me write a getting started guide for my API',
      'Structure the documentation for my developer tool',
      'Write clear error messages for these edge cases'
    ]
  }
];

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const KEY_API_ANTHROPIC = 'persona_chat_api_key';          // keep old name for compat
const KEY_API_OPENAI    = 'persona_chat_api_key_openai';
const KEY_PROVIDER      = 'persona_chat_provider';
const KEY_LAST          = 'persona_chat_last_persona';
const MODEL_ANTHROPIC   = 'claude-sonnet-4-6';
const MODEL_OPENAI      = 'gpt-4o';

let state = {
  apiKeyAnthropic: localStorage.getItem(KEY_API_ANTHROPIC) || '',
  apiKeyOpenAI:    localStorage.getItem(KEY_API_OPENAI)    || '',
  provider:        localStorage.getItem(KEY_PROVIDER)      || 'anthropic', // 'anthropic' | 'openai'
  currentPersona: null,
  messages: [],       // { role, content }
  streaming: false,
  theme: localStorage.getItem('persona_chat_theme') || 'dark',
  pendingPersonaId: null  // persona selected before key entered
};

function currentApiKey() {
  return state.provider === 'openai' ? state.apiKeyOpenAI : state.apiKeyAnthropic;
}

let modalProvider = 'anthropic'; // tracks selected tab inside the modal

// ‚îÄ‚îÄ‚îÄ DOM REFS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const $ = id => document.getElementById(id);
const landing = $('landing');
const chat = $('chat');
const modalOverlay = $('modal-overlay');
const toast = $('toast');

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function init() {
  applyTheme(state.theme);
  renderPersonas('all');
  updateApiPill();

  // Warn when opened from file:// (CORS will block API calls)
  if (location.protocol === 'file:') {
    $('file-banner').classList.remove('hidden');
    document.body.classList.add('has-banner');
  }

  // Event bindings
  $('theme-btn').onclick = toggleTheme;
  $('api-key-btn').onclick = openModal;
  $('api-status-pill').onclick = openModal;
  $('modal-close-btn').onclick = closeModal;
  $('modal-cancel-btn').onclick = closeModal;
  $('modal-save-btn').onclick = saveApiKey;
  $('api-key-input').onkeydown = e => { if (e.key === 'Enter') saveApiKey(); };
  $('toggle-key-visibility').onclick = toggleKeyVisibility;
  modalOverlay.onclick = e => { if (e.target === modalOverlay) closeModal(); };

  document.querySelectorAll('.provider-tab').forEach(t => {
    t.onclick = () => { modalProvider = t.dataset.provider; syncModalForProvider(); };
  });

  $('switch-persona-btn').onclick = switchPersona;
  $('clear-chat-btn').onclick = clearChat;
  $('send-btn').onclick = sendMessage;
  $('msg-input').onkeydown = handleInputKey;
  $('msg-input').oninput = autoResize;

  document.querySelectorAll('.cat-tab').forEach(t => {
    t.onclick = () => {
      document.querySelectorAll('.cat-tab').forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      renderPersonas(t.dataset.cat);
    };
  });
}

// ‚îÄ‚îÄ‚îÄ THEME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function applyTheme(t) {
  document.body.setAttribute('data-theme', t);
  $('theme-btn').textContent = t === 'dark' ? 'üåô' : '‚òÄÔ∏è';
}
function toggleTheme() {
  state.theme = state.theme === 'dark' ? 'light' : 'dark';
  localStorage.setItem('persona_chat_theme', state.theme);
  applyTheme(state.theme);
}

// ‚îÄ‚îÄ‚îÄ API PILL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateApiPill() {
  const dot = $('api-dot');
  const txt = $('api-status-text');
  const key = currentApiKey();
  const providerLabel = state.provider === 'openai' ? 'OpenAI' : 'Anthropic';
  if (key) {
    dot.classList.remove('no-key');
    txt.textContent = `${providerLabel} key set ¬∑ click to change`;
  } else {
    dot.classList.add('no-key');
    txt.textContent = 'Add API Key to start';
  }
}

// ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal() {
  modalProvider = state.provider;
  syncModalForProvider();
  $('api-key-input').type = 'password';
  $('toggle-key-visibility').textContent = 'üëÅ';
  $('toggle-key-visibility').title = 'Show key';
  $('modal-error').textContent = '';
  $('api-key-field').classList.remove('input-error');
  modalOverlay.classList.remove('hidden');
  setTimeout(() => $('api-key-input').focus(), 50);
}
function closeModal() {
  modalOverlay.classList.add('hidden');
  state.pendingPersonaId = null;
}
function toggleKeyVisibility() {
  const input = $('api-key-input');
  const btn = $('toggle-key-visibility');
  if (input.type === 'password') {
    input.type = 'text';
    btn.textContent = 'üôà';
    btn.title = 'Hide key';
  } else {
    input.type = 'password';
    btn.textContent = 'üëÅ';
    btn.title = 'Show key';
  }
}

function syncModalForProvider() {
  const isOpenAI = modalProvider === 'openai';
  document.querySelectorAll('.provider-tab').forEach(t =>
    t.classList.toggle('active', t.dataset.provider === modalProvider)
  );
  $('api-key-input').value    = isOpenAI ? state.apiKeyOpenAI : state.apiKeyAnthropic;
  $('api-key-label').textContent = isOpenAI ? 'OpenAI API Key' : 'Anthropic API Key';
  $('api-key-input').placeholder = isOpenAI ? 'sk-proj-...' : 'sk-ant-api03-...';
  $('get-key-link').href        = isOpenAI
    ? 'https://platform.openai.com/api-keys'
    : 'https://console.anthropic.com/settings/keys';
  $('get-key-link').textContent = isOpenAI
    ? 'Get your API key from OpenAI Platform ‚Üí'
    : 'Get your API key from Anthropic Console ‚Üí';
  $('modal-error').textContent = '';
  $('api-key-field').classList.remove('input-error');
}

function validateApiKeyFormat(key, provider) {
  const trimmed = key.trim();
  if (!trimmed) return { ok: false, msg: 'Please enter your API key.' };
  if (provider === 'anthropic') {
    if (!trimmed.startsWith('sk-ant-'))
      return { ok: false, msg: 'Anthropic keys start with sk-ant-. Get one at console.anthropic.com' };
    if (trimmed.length < 40)
      return { ok: false, msg: 'Key seems too short. Check for typos.' };
  } else {
    if (!trimmed.startsWith('sk-'))
      return { ok: false, msg: 'OpenAI keys start with sk-. Get one at platform.openai.com' };
    if (trimmed.length < 20)
      return { ok: false, msg: 'Key seems too short. Check for typos.' };
  }
  return { ok: true };
}

function persistKey(provider, val) {
  if (provider === 'anthropic') {
    state.apiKeyAnthropic = val;
    localStorage.setItem(KEY_API_ANTHROPIC, val);
  } else {
    state.apiKeyOpenAI = val;
    localStorage.setItem(KEY_API_OPENAI, val);
  }
  state.provider = provider;
  localStorage.setItem(KEY_PROVIDER, provider);
}

async function saveApiKey() {
  const val = $('api-key-input').value.trim();
  const errEl = $('modal-error');
  const fieldEl = $('api-key-field');
  const saveBtn = $('modal-save-btn');

  errEl.textContent = '';
  fieldEl.classList.remove('input-error');

  const validation = validateApiKeyFormat(val, modalProvider);
  if (!validation.ok) {
    errEl.textContent = validation.msg;
    fieldEl.classList.add('input-error');
    return;
  }

  saveBtn.classList.add('loading');
  saveBtn.disabled = true;
  saveBtn.textContent = 'Verifying...';

  const isOpenAI = modalProvider === 'openai';

  try {
    let res;
    if (isOpenAI) {
      res = await fetch('https://api.openai.com/v1/models', {
        method: 'GET',
        headers: { 'Authorization': `Bearer ${val}` }
      });
    } else {
      res = await fetch('https://api.anthropic.com/v1/models', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': val,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-calls': 'true'
        }
      });
    }

    if (res.status === 401) {
      const hint = isOpenAI ? 'platform.openai.com' : 'console.anthropic.com';
      errEl.textContent = `Invalid API key. Check it at ${hint} and try again.`;
      fieldEl.classList.add('input-error');
      return;
    }
    if (res.status === 429) {
      errEl.textContent = 'Rate limited. Please wait a moment and try again.';
      return;
    }
    if (!res.ok) {
      const data = await res.json().catch(() => ({}));
      errEl.textContent = data.error?.message || 'Verification failed. Please try again.';
      return;
    }

    persistKey(modalProvider, val);
    updateApiPill();
    closeModal();
    if (state.pendingPersonaId) {
      selectPersona(state.pendingPersonaId);
      state.pendingPersonaId = null;
    }
  } catch (e) {
    if (location.protocol === 'file:') {
      errEl.textContent = 'CORS: Open this page via GitHub Pages or a local server, not file://';
    } else if (e.message?.includes('fetch') || e.name === 'TypeError') {
      errEl.textContent = 'Network error. Saving key anyway ‚Äî try chatting once connected.';
      persistKey(modalProvider, val);
      updateApiPill();
      closeModal();
      if (state.pendingPersonaId) { selectPersona(state.pendingPersonaId); state.pendingPersonaId = null; }
    } else {
      persistKey(modalProvider, val);
      updateApiPill();
      closeModal();
      if (state.pendingPersonaId) { selectPersona(state.pendingPersonaId); state.pendingPersonaId = null; }
      showToast('Key saved. Try chatting ‚Äî if issues persist, verify your key.');
    }
  } finally {
    saveBtn.classList.remove('loading');
    saveBtn.disabled = false;
    saveBtn.textContent = 'Save & Continue';
  }
}

// ‚îÄ‚îÄ‚îÄ PERSONAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderPersonas(cat) {
  const wrap = $('personas-wrap');
  const lastId = localStorage.getItem(KEY_LAST);
  const filtered = cat === 'all' ? PERSONAS : PERSONAS.filter(p => p.category === cat);
  const categories = [...new Set(filtered.map(p => p.category))];

  wrap.innerHTML = categories.map(c => {
    const personas = filtered.filter(p => p.category === c);
    const catEmoji = { Tech: 'üíª', Product: 'üì¶', Business: 'üíº', Creative: 'üé®' }[c] || '';
    return `
      <div class="cat-section">
        <div class="cat-label">${catEmoji} ${c}</div>
        <div class="personas-grid">
          ${personas.map(p => personaCard(p, lastId)).join('')}
        </div>
      </div>`;
  }).join('');

  // Attach click handlers
  wrap.querySelectorAll('.persona-card').forEach(card => {
    card.onclick = () => {
      const pid = card.dataset.id;
      if (!currentApiKey()) {
        state.pendingPersonaId = pid;
        openModal();
      } else {
        selectPersona(pid);
      }
    };
  });
}

function personaCard(p, lastId) {
  return `
    <div class="persona-card${p.id === lastId ? ' last-used' : ''}" data-id="${p.id}">
      <div class="card-icon">${p.icon}</div>
      <div class="card-name">${p.name}</div>
      <div class="card-tagline">${p.tagline}</div>
      <div class="card-starters">
        ${p.starterPrompts.map(s => `<div class="card-starter-item">${s}</div>`).join('')}
      </div>
    </div>`;
}

function selectPersona(id) {
  const persona = PERSONAS.find(p => p.id === id);
  if (!persona) return;
  state.currentPersona = persona;
  state.messages = [];
  localStorage.setItem(KEY_LAST, id);
  showChat();
}

// ‚îÄ‚îÄ‚îÄ CHAT SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showChat() {
  landing.classList.add('hidden');
  chat.classList.remove('hidden');
  const p = state.currentPersona;

  // Sidebar
  $('sb-icon').textContent = p.icon;
  $('sb-name').textContent = p.name;
  $('sb-cat').textContent = p.category;
  $('sb-tagline').textContent = p.tagline;
  const sbStarters = $('sb-starters');
  sbStarters.innerHTML = p.starterPrompts.map(s =>
    `<button class="sidebar-starter">${s}</button>`
  ).join('');
  sbStarters.querySelectorAll('.sidebar-starter').forEach(btn => {
    btn.onclick = () => sendStarter(btn.textContent);
  });

  // Header
  $('ch-icon').textContent = p.icon;
  $('ch-name').textContent = p.name;
  $('ch-model').textContent = state.provider === 'openai'
    ? `Online ¬∑ GPT-4o`
    : `Online ¬∑ Claude claude-sonnet-4-6`;

  // Empty state
  $('es-icon').textContent = p.icon;
  $('es-title').textContent = `Chat with ${p.name}`;
  $('es-sub').textContent = p.tagline;
  const esChips = $('es-chips');
  esChips.innerHTML = p.starterPrompts.map(s =>
    `<button class="chip">${s}</button>`
  ).join('');
  esChips.querySelectorAll('.chip').forEach(chip => {
    chip.onclick = () => sendStarter(chip.textContent);
  });

  renderMessages();
  $('msg-input').focus();
}

function switchPersona() {
  chat.classList.add('hidden');
  landing.classList.remove('hidden');
  renderPersonas('all');
  document.querySelectorAll('.cat-tab').forEach(t => {
    t.classList.toggle('active', t.dataset.cat === 'all');
  });
}

function clearChat() {
  state.messages = [];
  renderMessages();
}

// ‚îÄ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderMessages() {
  const container = $('messages');
  const empty = $('empty-state');

  if (state.messages.length === 0) {
    empty.classList.remove('hidden');
    // remove all message rows
    container.querySelectorAll('.msg-row').forEach(r => r.remove());
    return;
  }

  empty.classList.add('hidden');
  // Clear and re-render (simpler for this implementation)
  container.querySelectorAll('.msg-row').forEach(r => r.remove());
  state.messages.forEach(msg => appendMessageDOM(msg.role, msg.content));
}

function appendMessageDOM(role, content, streaming = false) {
  const container = $('messages');
  const empty = $('empty-state');
  empty.classList.add('hidden');

  const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  const isUser = role === 'user';
  const p = state.currentPersona;

  const row = document.createElement('div');
  row.className = `msg-row ${isUser ? 'user' : 'ai'}`;
  row.innerHTML = `
    <div class="msg-avatar">${isUser ? 'üë§' : p.icon}</div>
    <div>
      <div class="msg-bubble${streaming ? ' cursor-blink' : ''}" data-role="${role}"></div>
      <div class="msg-time">${now}</div>
    </div>`;

  const bubble = row.querySelector('.msg-bubble');
  bubble.innerHTML = formatContent(content);

  container.appendChild(row);
  container.scrollTop = container.scrollHeight;
  return bubble;
}

function formatContent(text) {
  // Basic markdown: code blocks, inline code, bold, line breaks
  return text
    .replace(/```(\w*)\n?([\s\S]*?)```/g, (_, lang, code) =>
      `<pre><code>${escapeHtml(code.trim())}</code></pre>`)
    .replace(/`([^`]+)`/g, (_, code) => `<code>${escapeHtml(code)}</code>`)
    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
    .replace(/\*([^*]+)\*/g, '<em>$1</em>')
    .replace(/^### (.+)$/gm, '<strong>$1</strong>')
    .replace(/^## (.+)$/gm, '<strong>$1</strong>')
    .replace(/^# (.+)$/gm, '<strong>$1</strong>')
    .replace(/^[-‚Ä¢] (.+)$/gm, '‚Ä¢ $1')
    .replace(/\n/g, '<br>');
}

function escapeHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ‚îÄ‚îÄ‚îÄ SEND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleInputKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

function autoResize() {
  const el = $('msg-input');
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 140) + 'px';
}

function sendStarter(text) {
  $('msg-input').value = text;
  sendMessage();
}

async function sendMessage() {
  if (state.streaming) return;
  const input = $('msg-input');
  const text = input.value.trim();
  if (!text) return;

  input.value = '';
  input.style.height = 'auto';
  $('send-btn').disabled = true;

  // Add user message
  state.messages.push({ role: 'user', content: text });
  appendMessageDOM('user', text);

  // Show typing
  const typingRow = createTypingRow();

  try {
    await streamResponse(text, typingRow);
  } catch (err) {
    typingRow.remove();
    handleApiError(err);
    state.messages.pop(); // remove failed user message from state? No, keep it.
  } finally {
    state.streaming = false;
    $('send-btn').disabled = false;
    $('msg-input').focus();
  }
}

function createTypingRow() {
  const container = $('messages');
  const p = state.currentPersona;
  const row = document.createElement('div');
  row.className = 'msg-row ai';
  row.id = 'typing-row';
  row.innerHTML = `
    <div class="msg-avatar">${p.icon}</div>
    <div>
      <div class="msg-bubble">
        <div class="typing-indicator">
          <span></span><span></span><span></span>
        </div>
      </div>
    </div>`;
  container.appendChild(row);
  container.scrollTop = container.scrollHeight;
  return row;
}

// ‚îÄ‚îÄ‚îÄ STREAMING API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function streamResponse(userText, typingRow) {
  state.streaming = true;
  const p = state.currentPersona;
  const isOpenAI = state.provider === 'openai';

  let url, headers, body;
  if (isOpenAI) {
    url = 'https://api.openai.com/v1/chat/completions';
    headers = {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${state.apiKeyOpenAI}`
    };
    body = {
      model: MODEL_OPENAI,
      max_tokens: 2048,
      messages: [
        { role: 'system', content: p.systemPrompt },
        ...state.messages.map(m => ({ role: m.role, content: m.content }))
      ],
      stream: true
    };
  } else {
    url = 'https://api.anthropic.com/v1/messages';
    headers = {
      'Content-Type': 'application/json',
      'x-api-key': state.apiKeyAnthropic,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-calls': 'true'
    };
    body = {
      model: MODEL_ANTHROPIC,
      max_tokens: 2048,
      system: p.systemPrompt,
      messages: state.messages.map(m => ({ role: m.role, content: m.content })),
      stream: true
    };
  }

  const res = await fetch(url, { method: 'POST', headers, body: JSON.stringify(body) });

  if (!res.ok) {
    const errData = await res.json().catch(() => ({}));
    const err = new Error(errData.error?.message || `HTTP ${res.status}`);
    err.status = res.status;
    throw err;
  }

  // Replace typing row with real bubble
  typingRow.remove();
  const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  const container = $('messages');
  const row = document.createElement('div');
  row.className = 'msg-row ai';
  row.innerHTML = `
    <div class="msg-avatar">${p.icon}</div>
    <div>
      <div class="msg-bubble cursor-blink"></div>
      <div class="msg-time">${now}</div>
    </div>`;
  container.appendChild(row);
  const bubble = row.querySelector('.msg-bubble');

  let fullText = '';
  const reader = res.body.getReader();
  const decoder = new TextDecoder();

  while (true) {
    const { done, value } = await reader.read();
    if (done) break;

    const chunk = decoder.decode(value, { stream: true });
    const lines = chunk.split('\n');

    for (const line of lines) {
      if (!line.startsWith('data: ')) continue;
      const data = line.slice(6).trim();
      if (data === '[DONE]') continue;
      try {
        const parsed = JSON.parse(data);
        let delta = '';
        if (isOpenAI) {
          delta = parsed.choices?.[0]?.delta?.content || '';
        } else if (parsed.type === 'content_block_delta' && parsed.delta?.type === 'text_delta') {
          delta = parsed.delta.text;
        }
        if (delta) {
          fullText += delta;
          bubble.innerHTML = formatContent(fullText);
          container.scrollTop = container.scrollHeight;
        }
      } catch (_) { /* skip malformed lines */ }
    }
  }

  bubble.classList.remove('cursor-blink');
  state.messages.push({ role: 'assistant', content: fullText });
}

// ‚îÄ‚îÄ‚îÄ ERROR HANDLING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleApiError(err) {
  let msg = 'Something went wrong. Please try again.';
  if (err.status === 401) {
    msg = 'Invalid API key. Click the key icon to update it.';
    if (state.provider === 'openai') {
      state.apiKeyOpenAI = '';
      localStorage.removeItem(KEY_API_OPENAI);
    } else {
      state.apiKeyAnthropic = '';
      localStorage.removeItem(KEY_API_ANTHROPIC);
    }
    updateApiPill();
  } else if (err.status === 429) {
    msg = 'Rate limit hit. Please wait a moment and try again.';
  } else if (err.status === 529 || err.message?.includes('overloaded')) {
    msg = 'Claude is currently overloaded. Please try again in a moment.';
  } else if (!navigator.onLine) {
    msg = 'No internet connection. Check your network and try again.';
  } else if (err.name === 'TypeError' || (err.message && err.message.toLowerCase().includes('fetch'))) {
    if (location.protocol === 'file:') {
      msg = 'CORS blocked ‚Äî you must open this page via GitHub Pages or a local server, not file://. See the banner above.';
    } else {
      msg = 'Network error reaching the API. Check your internet connection and try again.';
    }
  } else if (err.message) {
    msg = err.message;
  }
  showToast(msg);
}

function showToast(msg) {
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 5000);
}

// ‚îÄ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
init();
</script>
</body>
</html>
